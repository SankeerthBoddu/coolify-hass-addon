#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start Coolify service
# ==============================================================================

bashio::log.info "Starting Coolify..."

# Read configuration options
APP_URL=$(bashio::config 'APP_URL')
APP_KEY=$(bashio::config 'APP_KEY')
PUSHER_APP_ID=$(bashio::config 'PUSHER_APP_ID')
PUSHER_APP_KEY=$(bashio::config 'PUSHER_APP_KEY')
PUSHER_APP_SECRET=$(bashio::config 'PUSHER_APP_SECRET')

# Generate APP_KEY if not provided
if [ -z "$APP_KEY" ]; then
    bashio::log.info "Generating APP_KEY..."
    APP_KEY=$(openssl rand -base64 32)
    bashio::log.info "Generated APP_KEY: base64:${APP_KEY}"
fi

# Generate PUSHER keys if not provided
if [ -z "$PUSHER_APP_KEY" ]; then
    PUSHER_APP_KEY=$(openssl rand -hex 16)
fi

if [ -z "$PUSHER_APP_SECRET" ]; then
    PUSHER_APP_SECRET=$(openssl rand -hex 32)
fi

# Export environment variables
export APP_URL="${APP_URL}"
export APP_KEY="base64:${APP_KEY}"
export PUSHER_APP_ID="${PUSHER_APP_ID}"
export PUSHER_APP_KEY="${PUSHER_APP_KEY}"
export PUSHER_APP_SECRET="${PUSHER_APP_SECRET}"
export DB_CONNECTION="sqlite"
export DB_DATABASE="/data/coolify.db"

# Ensure data directory exists
mkdir -p /data

# Start Coolify
exec php artisan serve --host=0.0.0.0 --port=8000
